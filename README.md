X3 Map Surgeon
==============

This is a Python utility for performing "plastic surgery" on the galaxy map in [Egosoft's X3](http://www.egosoft.com/) videogame series. It was designed specifically to simplify updating a custom map for new versions of the X3 overhaul [Litcube's Universe](https://code.google.com/p/litcubesuniverse/wiki/Index), which is based on **X3: Albion Prelude**. However, this utility will also work for vanilla versions of **X3:AP**, **X3: Terran Conflict**, and possibly **X3: Reunion**.

*Map Surgeon* consists of several commandline utilities, plus a set of input files, referred to as Schemas, which instruct *Map Surgeon* on what changes to make to the galaxy map. All the final game files generated by these tools are saved into an organized package directory ready to be copied directly into the root X3 game folder.

These tools are all command-line interface (CLI). Designing nice graphical interfaces are not my specialty, and I find it much more efficient to use CLI for these tasks anyway. If anyone is motivated to created a GUI for these tools, you are more than welcome.


## The Tools

All the tools will provide basic help on the arguments they accept to configure their behavior and the filenames used. To display this help info, enter into the command-line:

    python <toolname>.py -h


### Input files

All the tools require input files, and these files are located in *mapsurgeon\input\\*. Each of the tools will automatically load the input files it needs from that directory using default values defined in the *mapsurgeon.ini* file located in the main directory. If you wish to use different paths or filenames for the input or output files, you can do so by providing arguments to the tool at run time or by editing the configuration settings.

* x3\_universe.xml
* x3\_universe\_remap.xml
* RemapSchemaEditor.xlsx
* Jobs.txt
* gate\_schema.xml
* newsectors.xml

**x3\_universe.xml**: the source map that is used as the starting point for the remap project.

**x3\_universe\_remap.xml**: the reference map used to generate the *newsectors.xml* and *gate\_schema.xml* for subsequent map updates. This needs to be a copy of the universe map fully updated to the remap layout. This includes any manual changes made to adjust sector objects, like gates for the new layout. Once all manual changes have been made and exported, the exported map should be renamed and copied into the *mapsurgeon\input* folder.

**RemapSchemaEditor.xlsx**: this is the primary remap planning tool and guide for the remapping utility. The Main spreadsheet is where sectors are flagged to be deleted, new sectors added, and all sector coordinates mapped to new ones. Each sector can be assigned new gate combinations, and each gate linked to a target sector.

**Jobs.txt**: the original Jobs file for the original map. *gen\_jobs.py* will update this file for the new map layout.

**gate\_schema.xml**: a master xml file the specifies the locations of all gates in the remapped layout. This file is generated by *gen\_gateschema.py* from the *x3\_universe\_remap.xml* and ensures any manual gate adjustments in the new map are retained for future map updates.

**newsectors.xml**: this contains all new sectors data to be inserted into the new universe map. It is generated by *gen\_newsectors.py* from the *x3\_universe\_remap.xml*.

### Output files

By default all files generated for the new map mod will be saved in a directory tree organized for easy installion into X3 and for packaging into a Zip file. Not all files included in the *mapsurgeon\output\_package* directory are generated by the *mapsurgeon* tools. Some have to be edited by hand for any changes you want to make. Others, like *objects\cut\00749.bod*, can be regenerated in-game using a script, included in Litcube's Universe and available in the forums. The structure of the package directory and its contents will be described here:

* addons\director\LUremap.xml
* addons\maps\x3\_universe.xml
* addons\mov\00044.pck
* addons\t\9337-L044.xml
* addons\types\Jobs.txt
* addons\types\Lensflares.txt
* addons\types\TSuns.txt
* objects\cut\00749.bod

**addons\director\LUremap.xml**: a mission director file that instructs the game to load *addons\t\9337-L044.xml* at game start. Should not need to be edited, unless changes are made to which language file to be loaded.

**addons\maps\x3\_universe.xml**: the universe map. This file is generated by *remap\_cli.py*.

**addons\mov\00044.pck**: Index for all audio clips used in-game.

**addons\t\9337-L044.xml**: The language file with the updated sector names and descriptions. 'L044' is the identifier code for English. If another language needs to be supported, then this file will need to be copied, renamed, and edited as needed for that language. This file is generated by *gen\_readtext.py*.

**addons\types\Jobs.txt**: This file defines NPC traffic in the universe. It sets spawn rates, behavior, stats, locations in the universe, and more. The amount of changes you need to make to this file depend greatly on what kind of changes you make to the universe and what kind of performance room there is available in the game and the hosting computer. At a minimum, all jobs with assigned home sectors (mostly military patrols) have to be reassigned to the new sector coordinates defined in your map. *gen\_jobs.py* will update all assigned sector coordinates in the Jobs file. After that, you have to determine if the generated jobs work well for your new universe, or if job spawn rates need to be increased or decreased, new jobs need to be created for new sectors, and so on.

**addons\types\Lensflares.txt**: Used to define new lens flare effects which work in conjunction with new sun types you can create for new sectors you choose to create. Edit by hand if changes are needed.

**addons\types\TSuns.txt**: New sun types can be defined in here. Edit by hand.

**objects\cut\00749.bod**: Animation definition file for the in-game Galaxy map. This file defines how the galaxy map appears in-game. It creates the sectors and the gate links that appear between them, plus how they are positioned in relation to each other as you scroll around the map. This includes any 3D visualization effects by raising or lowering sectors. Litcube's BOD script, available in the forums and included in LU, will generate this file so it produces a flat galaxy map.



### remap\_cli.py

*remap\_cli.py* is the program that performs the map surgery--in other words, alters an existing map by removing undesired sectors, rearranging the remaining sectors, and adding any new sectors you have created.

    usage: python remap_cli.py -g USEGATESCHEMA [-h --version --inputmap FILENAME 
            --inputschema FILENAME --inputnewsectors FILENAME --inputgates FILENAME --outputmap FILENAME]

*remap.py* requires 1 argument in order to proceed with the remap procedure.

* USEGATESCHEMA - This argument must be a 0 or 1. **1** instructs *remap.py* to use *gate\_schema.xml* when placing new gates in sectors. The gate schema specifies the position and orientation of these gates in their sectors. **0** instructs *remap.py* to apply default positioning rules to these new gates. This option is required when an accurate *gate\_schema.xml* hasn't yet been generated for a new map.
* INPUTMAP - the original galaxy map to be altered (default: x3\_universe.xml).
* INPUTSCHEMA - the Remap Schema Excel file that specifies what sectors are to be removed (if any), new sectors to be added, and the new coordinates for all map sectors (default: RemapSchemaEditor.xlsx).
* INPUTNEWSECTORS - an XML file that holds all new sectors and their contents to be added to the galaxy (default: newsectors.xml)
* INPUTGATES - the XML Gate Schema that specifies all gate position and orientation coordinates for all sectors in the new map. If this file is not supplied, Map Surgeon will place all new gates in the galaxy with default coordinates in their sectors (for their cardinal location.) This means they may be placed poorly in relation to the other objects in the sector will need to be checked and adjusted by hand in-game using the Galaxy Editor.
* OUTPUTMAP - the filename for the new galaxy map to be generated

### gen\_jobs.py

*gen\_jobs.py* is a helper tool that updates a Jobs file for compatibility with the remapped universe. Currently, this update procedure just reassigns job home sectors to the new sector coordinates. Additional updates for the new universe may need to be performed by hand, and fortunately these changes are typically easy and quick to complete.

    usage: python gen_jobs.py [-h --version --inputjobs FILENAME --inputschema FILENAME --outputjobs FILENAME]

### gen\_readtext.py

*gen\_readtext.py* is a helper utility to generate an updated ReadText file containing the new sector names and descriptions, mapped to the updated Text Id codes, which also correspond to the new sector coordinates. The new text id codes are automatically generated in the Remap Schema Editor.

    usage: python gen_readtext.py [-h --version --inputschema FILENAME --outputtext FILENAME]

### gen\_newsectors.py

    usage: python gen_newsectors.py [-h --version --inputschema FILENAME --outputtext FILENAME]

*gen\_newsectors.py* is a helper utility used to auto-generate the New Sectors XML schema file from an exemplar galaxy map. The New Sectors schema file contains just the XML records of new sectors to be added to the galaxy map and all objects to placed in those sectors. Because fine-tuning a new galaxy map (placing sector objects, positioning gates, etc.) typically requires working in the X3 Galaxy Editor, creating the initial version of a new map for the game has to be completed before this utility is fully useful. With a final draft of the galaxy map on hand, you can input it into *gen\_newsectors.py* to generate the New Sectors Schema. From that point, repeated runs of *remap\_cli.py* to generate updated versions of the galaxy map can just use this schema file to recreate the new sectors.

### gen\_gateschema.py

    usage: python gen_gateschema.py [-h --version --inputschema FILENAME --outputtext FILENAME]
    
*gen\_gateschema.py* is a helper utility used to auto-generate the Gate Schema XML file from an exemplar galaxy map. The Gate Schema file contains just the XML records of all gates in the new galaxy map. Because fine-tuning a new galaxy map, including positioning new gates to ensure they aren't too close to other sector objects, typically requires working in the X3 Galaxy Editor, creating the initial version of a new map for the game has to be completed before this utility is fully useful. With a final draft of the galaxy map on hand, you can input it into *gen\_gateschema.py* to generate the Gate Schema. From that point, repeated runs of *remap\_cli.py* to generate updated versions of the galaxy map can just use this schema file to recreate the gate network.


##Example Usage

Request help info on using a tool:

    python gen_remap_cli.py -h


Request the current version number of a tool:

    python gen_jobs.py --version


Generate New Map, using default filenames and paths from mapsurgeon.ini:

    python remap_cli.py -g 1


Generate New Map, using custom filenames:

    python remap_cli.py -g 1 --inputmap=x3_universe_LUV.xml --inputschema=RemapSchemaEditor.xlsx
            --inputnewsectors=newsectors.xml --inputgates=gate_schema.xml --outputmap=x3_universe_out.xml


Generate New Sectors Schema, using default filenames and paths from mapsurgeon.ini:

    python gen_newsectors.py


Generate New Sectors Schema, using custom filenames:

    python gen_newsectors.py --referencemap=x3_universe.xml --inputschema=RemapSchemaEditor.xlsx 
            --sectorsout=newsectors.xml


Generate Gate Schema:

    python gen_schema.py


Generate Jobs file:

    python gen_jobs.py
   

Generate ReadText file of updated sector names and descriptions:

    python gen_readtext.py

